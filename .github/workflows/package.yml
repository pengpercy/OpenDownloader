name: Package

on:
  workflow_call:
    inputs:
      version:
        description: Package version
        required: true
        type: string

jobs:
  # ===========================================================================
  # Windows Packaging
  # ===========================================================================
  windows:
    name: Package Windows
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - rid: win-x64
            archive_name: OpenDownloader-win-x64
          - rid: win-arm64
            archive_name: OpenDownloader-win-arm64
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.rid }}
          path: publish/${{ matrix.rid }}

      - name: Package Windows
        run: |
          Compress-Archive -Path publish/${{ matrix.rid }}/* -DestinationPath ${{ matrix.archive_name }}.zip

      - name: Upload Package Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ matrix.rid }}
          path: ${{ matrix.archive_name }}.*

  # ===========================================================================
  # Linux Packaging
  # ===========================================================================
  linux:
    name: Package Linux
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - rid: linux-x64
            archive_name: OpenDownloader-linux-x64
          - rid: linux-arm64
            archive_name: OpenDownloader-linux-arm64
    steps:
      - uses: actions/checkout@v4

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.rid }}
          path: publish/${{ matrix.rid }}

      - name: Install Linux Packaging Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems build-essential rpm
          sudo gem install --no-document fpm

      - name: Package Linux
        run: |
          chmod +x build/package_linux.sh
          
          # Run package script
          # Note: package_linux.sh expects: <rid> <version> <output_dir> <publish_dir>
          ./build/package_linux.sh ${{ matrix.rid }} ${{ inputs.version }} build_output publish/${{ matrix.rid }}
          
          # Also create a tar.gz as a fallback
          cd publish/${{ matrix.rid }}
          tar -czvf ../../${{ matrix.archive_name }}.tar.gz *

      - name: Upload Package Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ matrix.rid }}
          path: |
            build_output/*.deb
            build_output/*.rpm
            build_output/*.AppImage
            ${{ matrix.archive_name }}.*
          if-no-files-found: ignore

  # ===========================================================================
  # macOS Packaging
  # ===========================================================================
  macos:
    name: Package macOS
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - rid: osx-x64
            archive_name: OpenDownloader-osx-x64
          - rid: osx-arm64
            archive_name: OpenDownloader-osx-arm64
    steps:
      - uses: actions/checkout@v4

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.rid }}
          path: publish/${{ matrix.rid }}

      - name: Package macOS
        run: |
          chmod +x build/package_osx.sh
          
          # Reconstruct directory structure expected by package_osx.sh
          # It expects: src/OpenDownloader/bin/Release/net10.0/<rid>/publish
          mkdir -p src/OpenDownloader/bin/Release/net10.0/${{ matrix.rid }}/publish
          cp -a publish/${{ matrix.rid }}/. src/OpenDownloader/bin/Release/net10.0/${{ matrix.rid }}/publish/
          
          ./build/package_osx.sh ${{ matrix.rid }} ${{ inputs.version }} build_output
          
          # Create ZIP as well
          cd publish/${{ matrix.rid }}
          zip -r ../../${{ matrix.archive_name }}.zip *

      - name: Upload Package Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ matrix.rid }}
          path: |
            build_output/*.dmg
            ${{ matrix.archive_name }}.*
          if-no-files-found: ignore
