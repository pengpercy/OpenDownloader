name: Publish Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  APP_NAME: 'OpenDownloader'
  VERSION: '1.0.0' # In real usage, extract from tag

jobs:
  # ==============================================================================
  # Windows Build
  # ==============================================================================
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Publish AOT
        run: |
          dotnet publish src/OpenDownloader/OpenDownloader.csproj -c Release -r win-${{ matrix.arch }} -o publish/win-${{ matrix.arch }} /p:PublishAot=true /p:TrimMode=full
      
      - name: Zip Artifacts
        run: |
          Compress-Archive -Path publish/win-${{ matrix.arch }}/* -DestinationPath win-${{ matrix.arch }}.zip
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: win-${{ matrix.arch }}
          path: win-${{ matrix.arch }}.zip

  # ==============================================================================
  # macOS Build
  # ==============================================================================
  build-macos:
    strategy:
      matrix:
        include:
          - arch: x64
            runner: macos-13 # Intel
          - arch: arm64
            runner: macos-14 # Apple Silicon
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          
      - name: Publish AOT
        run: |
          dotnet publish src/OpenDownloader/OpenDownloader.csproj -c Release -r osx-${{ matrix.arch }} -o src/OpenDownloader/bin/Release/net10.0/osx-${{ matrix.arch }}/publish /p:PublishAot=true /p:TrimMode=full

      - name: Package DMG
        run: |
          chmod +x build/package_osx.sh
          ./build/package_osx.sh osx-${{ matrix.arch }} ${{ env.VERSION }} artifacts
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: osx-${{ matrix.arch }}
          path: artifacts/*.dmg

  # ==============================================================================
  # Linux Build
  # ==============================================================================
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang zlib1g-dev ruby-full
          # Install FPM for RPM building
          sudo gem install fpm
          
      - name: Install Cross-Compilation Tools (if arm64)
        if: matrix.arch == 'arm64'
        run: |
          sudo apt-get install -y gcc-aarch64-linux-gnu llvm
          
      - name: Publish AOT
        run: |
          dotnet publish src/OpenDownloader/OpenDownloader.csproj -c Release -r linux-${{ matrix.arch }} -o src/OpenDownloader/bin/Release/net10.0/linux-${{ matrix.arch }}/publish /p:PublishAot=true /p:TrimMode=full

      - name: Package (Deb, Rpm, AppImage)
        run: |
          chmod +x build/package_linux.sh
          ./build/package_linux.sh linux-${{ matrix.arch }} ${{ env.VERSION }} artifacts
          
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}
          path: artifacts/*

  # ==============================================================================
  # Release
  # ==============================================================================
  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/**/*
