name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # 1. Build Job (Calls build.yml)
  build:
    name: Build
    uses: ./.github/workflows/build.yml

  # 2. Extract Version
  version:
    name: Prepare Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Output version string
        id: version
        env:
          TAG: ${{ github.ref_name }}
        run: echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"

  # 3. Package Job (Calls package.yml)
  package:
    needs: [build, version]
    name: Package
    uses: ./.github/workflows/package.yml
    with:
      version: ${{ needs.version.outputs.version }}

  # 4. Release Job
  release:
    needs: [package, version]
    name: Release
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Download All Packages
      uses: actions/download-artifact@v4
      with:
        pattern: package-*
        path: dist
        merge-multiple: true

    - name: List Files
      run: ls -R dist

    - name: Create Release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG: ${{ github.ref_name }}
        VERSION: ${{ needs.version.outputs.version }}
      run: |
        # Check if release exists, if not create it
        gh release create "$TAG" --title "$TAG" --generate-notes || true
        
        # Upload assets
        gh release upload "$TAG" dist/* --clobber
