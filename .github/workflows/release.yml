name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            rid: linux-x64
            archive_name: OpenDownloader-linux-x64
          - os: windows-latest
            rid: win-x64
            archive_name: OpenDownloader-win-x64
          - os: macos-latest
            rid: osx-x64
            archive_name: OpenDownloader-osx-x64
          - os: macos-latest
            rid: osx-arm64
            archive_name: OpenDownloader-osx-arm64

    steps:
    - uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 10.0.x

    # Restore dependencies (including NuGet packages)
    - name: Restore dependencies
      run: dotnet restore

    # Build and Publish
    - name: Publish
      run: |
        dotnet publish src/OpenDownloader/OpenDownloader.csproj -c Release -r ${{ matrix.rid }} --self-contained -p:PublishSingleFile=true -o publish/${{ matrix.rid }}

    # Package based on OS
    # Windows: Zip
    - name: Package Windows
      if: matrix.os == 'windows-latest'
      run: |
        Compress-Archive -Path publish/${{ matrix.rid }}/* -DestinationPath ${{ matrix.archive_name }}.zip

    # Linux: Tar.gz
    - name: Package Linux
      if: matrix.os == 'ubuntu-latest'
      run: |
        cd publish/${{ matrix.rid }}
        tar -czvf ../../${{ matrix.archive_name }}.tar.gz *

    # macOS: DMG (Using hdiutil, only available on macOS runner)
    - name: Package macOS
      if: runner.os == 'macOS'
      run: |
        chmod +x build/package_osx.sh
        # Extract version from tag (v1.0.0 -> 1.0.0)
        VERSION=${GITHUB_REF#refs/tags/v}
        # Run package script
        # The script expects: <rid> <version> <output_dir>
        # And it expects published files in src/OpenDownloader/bin/Release/net10.0/<rid>/publish
        # But we published to 'publish/<rid>' above.
        # Let's adjust the script or move files to expected location.
        # Easier: Adjust the script call or logic? 
        # Actually, our script has hardcoded paths. Let's make it flexible or just move files.
        mkdir -p src/OpenDownloader/bin/Release/net10.0/${{ matrix.rid }}/publish
        cp -a publish/${{ matrix.rid }}/. src/OpenDownloader/bin/Release/net10.0/${{ matrix.rid }}/publish/
        
        ./build/package_osx.sh ${{ matrix.rid }} $VERSION build_output
        
        # Rename the dmg to match artifact name pattern if needed, but script names it OpenDownloader_1.0.0_osx-x64.dmg
        # Let's just find it.
        find build_output -name "*.dmg" -exec mv {} ${{ matrix.archive_name }}.dmg \;

    # Upload Artifacts to Release
    - name: Upload binaries to release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: ${{ matrix.archive_name }}.*
        tag: ${{ github.ref }}
        overwrite: true
        file_glob: true
